From 0dedf6df1353c4872be9e35236de5c027761e8b7 Mon Sep 17 00:00:00 2001
From: Brecht Van Lommel <brecht@blender.org>
Date: Wed, 22 May 2024 21:25:55 +0200
Subject: [PATCH 1/4] Support HIP_PATH on Linux, and prefer it over PATH on all
 platforms

---
 premake5.lua | 75 ++++++++++++++++++++++++++++++----------------------
 1 file changed, 43 insertions(+), 32 deletions(-)

diff --git a/premake5.lua b/premake5.lua
index 8566cfb..0c78fcb 100644
--- a/premake5.lua
+++ b/premake5.lua
@@ -92,39 +92,50 @@ function get_hip_sdk_verion()
 	PATH = os.getenv("PATH")
 	hipInPath = false
 
-	-- check if HIP is in the PATH environement variable
-	for token in string.gmatch(PATH, "[^;]+") do
-		if string.find(token, 'hip') then
-			if os.isfile(path.join(token, 'hipcc')) then
-				hipInPath = true
-			end
-		end
-	end
-	
-	if os.ishost("windows") then
-        if hipInPath then
-			hipCommand = 'hipcc'
-		elseif not HIP_PATH then
-			hipCommand = root .. 'hipSdk\\bin\\hipcc'
-		else
-            if string.sub(HIP_PATH, -1, -1) == '\\' or string.sub(HIP_PATH, -1, -1) == '/' then
-                HIP_PATH = string.sub(HIP_PATH, 1, -2)
+    if HIP_PATH then
+        -- Use explicit path to hip if specific.
+        -- HIP_PATH is expected to look like: C:\Program Files\AMD\ROCm\5.7
+        if string.sub(HIP_PATH, -1, -1) == '\\' or string.sub(HIP_PATH, -1, -1) == '/' then
+            HIP_PATH = string.sub(HIP_PATH, 1, -2)
+        end
+        if os.ishost("windows") then
+            hipCommand = '\"' .. HIP_PATH..'\\bin\\'..hipCommand .. '\"'
+        else
+            hipCommand = '\"' .. HIP_PATH..'/bin/'..hipCommand .. '\"'
+        end
+    else
+        -- check if HIP is in the PATH environement variable
+        if os.ishost("windows") then
+            path_split_pattern = "[^;]+"
+        else
+            path_split_pattern = "[^:]+"
+        end
+
+        for token in string.gmatch(PATH, path_split_pattern) do
+            if string.find(token, 'hip') then
+                if os.isfile(path.join(token, 'hipcc')) then
+                    hipInPath = true
+                end
             end
-			-- HIP_PATH is expected to look like:   C:\Program Files\AMD\ROCm\5.7
-			hipCommand = '\"' .. HIP_PATH..'\\bin\\'..hipCommand .. '\"'
-		end
-	end
-	
-	tmpFile = os.tmpname ()
-	os.execute (hipCommand .. " --version > " .. tmpFile)
-	
-	local version
-	for line in io.lines (tmpFile) do
-		print (line)
-		version =  string.sub(line, string.find(line, "%d.%d"))
-		break
-	end
-	os.remove (tmpFile)
+        end
+
+        if hipInPath then
+            hipCommand = 'hipcc'
+        elseif os.ishost("windows") then
+            hipCommand = root .. 'hipSdk\\bin\\hipcc'
+        end
+    end
+
+    tmpFile = os.tmpname ()
+    os.execute (hipCommand .. " --version > " .. tmpFile)
+
+    local version
+    for line in io.lines (tmpFile) do
+        print (line)
+        version =  string.sub(line, string.find(line, "%d.%d"))
+        break
+    end
+    os.remove (tmpFile)
 
     if version == nil or version == '' then
         version = "HIP_SDK_NOT_FOUND"
-- 
2.43.2


From ed86075897be7a56c346b1fc517732b8146cb3de Mon Sep 17 00:00:00 2001
From: Brecht Van Lommel <brecht@blender.org>
Date: Wed, 22 May 2024 21:25:42 +0200
Subject: [PATCH 2/4] Add build option to disable unit tests

---
 premake5.lua | 121 +++++++++++++++++++++++++++------------------------
 1 file changed, 65 insertions(+), 56 deletions(-)

diff --git a/premake5.lua b/premake5.lua
index 0c78fcb..f76a8bd 100644
--- a/premake5.lua
+++ b/premake5.lua
@@ -19,6 +19,12 @@ newoption {
     description = "Use hiprtew"
 }
 
+newoption {
+    trigger = "unittest",
+    description = "Build unit tests",
+    default = true
+}
+
 function copydir(src_dir, dst_dir, filter, single_dst_dir)
     filter = filter or "**"
     src_dir = src_dir .. "/"
@@ -256,63 +262,66 @@ workspace "hiprt"
     files {"contrib/Orochi/contrib/**.h", "contrib/Orochi/contrib/**.cpp"}
     files {"contrib/Orochi/ParallelPrimitives/**.h", "contrib/Orochi/ParallelPrimitives/**.cpp"}
 
-	
-    project( "unittest" )
-        cppdialect "C++20"
-        kind "ConsoleApp"
-	    if _OPTIONS["bitcode"] then
-	    	defines {"HIPRT_BITCODE_LINKING"}
-	    end
-        if os.ishost("windows") then
-            buildoptions { "/wd4244" }
-            links{ "version" }
-        end
-        externalincludedirs {"./"}
-		links { HIPRT_NAME }
-		
-        if os.ishost("linux") then
-            links { "pthread", "dl" }
-        end
-        files { "test/hiprtT*.h", "test/hiprtT*.cpp", "test/shared.h", "test/main.cpp", "test/CornellBox.h", "test/kernels/*.h" }
-        externalincludedirs { "./contrib/Orochi/" }
-        files {"contrib/Orochi/Orochi/**.h", "contrib/Orochi/Orochi/**.cpp"}
-        files {"contrib/Orochi/contrib/**.h", "contrib/Orochi/contrib/**.cpp"}
 
-        files { "contrib/gtest-1.6.0/gtest-all.cc" }
-        externalincludedirs { "contrib/gtest-1.6.0/" }
-        defines { "GTEST_HAS_TR1_TUPLE=0" }
-        externalincludedirs { "contrib/embree/include/" }
-        if os.istarget("windows") then
-            libdirs{"contrib/embree/win/"}
-            copydir( "./contrib/embree/win", "./dist/bin/Release/", "*.dll" )
-            copydir( "./contrib/embree/win", "./dist/bin/Debug/", "*.dll" )
-			libdirs{"contrib/bin/win64"}
-            copydir( "./contrib/Orochi/contrib/bin/win64", "./dist/bin/Release/", "*.dll" )
-            copydir( "./contrib/Orochi/contrib/bin/win64", "./dist/bin/Debug/", "*.dll" )
-        end
-        if os.istarget("linux") then
-            libdirs{"contrib/embree/linux/"}
-        end
-        links{ "embree4", "tbb" }
-		if _OPTIONS["hiprtew"] then
+    if _OPTIONS["unittest"] then
+        project( "unittest" )
+            cppdialect "C++20"
+            kind "ConsoleApp"
+            if _OPTIONS["bitcode"] then
+                defines {"HIPRT_BITCODE_LINKING"}
+            end
+            if os.ishost("windows") then
+                buildoptions { "/wd4244" }
+                links{ "version" }
+            end
+            externalincludedirs {"./"}
+            links { HIPRT_NAME }
+
+            if os.ishost("linux") then
+                links { "pthread", "dl" }
+            end
+            files { "test/hiprtT*.h", "test/hiprtT*.cpp", "test/shared.h", "test/main.cpp", "test/CornellBox.h", "test/kernels/*.h" }
+            externalincludedirs { "./contrib/Orochi/" }
+            files {"contrib/Orochi/Orochi/**.h", "contrib/Orochi/Orochi/**.cpp"}
+            files {"contrib/Orochi/contrib/**.h", "contrib/Orochi/contrib/**.cpp"}
+
+            files { "contrib/gtest-1.6.0/gtest-all.cc" }
+            externalincludedirs { "contrib/gtest-1.6.0/" }
+            defines { "GTEST_HAS_TR1_TUPLE=0" }
+            externalincludedirs { "contrib/embree/include/" }
+            if os.istarget("windows") then
+                libdirs{"contrib/embree/win/"}
+                copydir( "./contrib/embree/win", "./dist/bin/Release/", "*.dll" )
+                copydir( "./contrib/embree/win", "./dist/bin/Debug/", "*.dll" )
+                libdirs{"contrib/bin/win64"}
+                copydir( "./contrib/Orochi/contrib/bin/win64", "./dist/bin/Release/", "*.dll" )
+                copydir( "./contrib/Orochi/contrib/bin/win64", "./dist/bin/Debug/", "*.dll" )
+            end
+            if os.istarget("linux") then
+                libdirs{"contrib/embree/linux/"}
+            end
+            links{ "embree4", "tbb" }
+
+        if _OPTIONS["hiprtew"] then
              project( "hiprtewtest" )
-                     kind "ConsoleApp"
-                     defines {"HIPRT_EXPORTS"}
-					 defines {"USE_HIPRTEW"}
-                     if os.ishost("windows") then
-                             buildoptions { "/wd4244" }
-                             links{ "version" }
-                     end
-                     externalincludedirs {"./", "./contrib/Orochi/"}
-                     if os.ishost("linux") then
-                             links { "pthread", "dl"}
-                     end
-					 files {"contrib/Orochi/Orochi/**.h", "contrib/Orochi/Orochi/**.cpp"}
-					 files {"contrib/Orochi/contrib/**.h", "contrib/Orochi/contrib/**.cpp"}
-                     files { "test/hiprtewTest.h", "test/hiprtewTest.cpp" }
-			
-                     files { "contrib/gtest-1.6.0/gtest-all.cc" }
-                     externalincludedirs { "contrib/gtest-1.6.0/" }
-                     defines { "GTEST_HAS_TR1_TUPLE=0" }
+                 kind "ConsoleApp"
+                 defines {"HIPRT_EXPORTS"}
+                 defines {"USE_HIPRTEW"}
+                 if os.ishost("windows") then
+                         buildoptions { "/wd4244" }
+                         links{ "version" }
+                 end
+                 externalincludedirs {"./", "./contrib/Orochi/"}
+                 if os.ishost("linux") then
+                         links { "pthread", "dl"}
+                 end
+                 files {"contrib/Orochi/Orochi/**.h", "contrib/Orochi/Orochi/**.cpp"}
+                 files {"contrib/Orochi/contrib/**.h", "contrib/Orochi/contrib/**.cpp"}
+                 files { "test/hiprtewTest.h", "test/hiprtewTest.cpp" }
+
+                 files { "contrib/gtest-1.6.0/gtest-all.cc" }
+                 externalincludedirs { "contrib/gtest-1.6.0/" }
+                 defines { "GTEST_HAS_TR1_TUPLE=0" }
+        end
     end
 
-- 
2.43.2


From 130a5ea732f110da3a77bf7936db6f8522d2cb20 Mon Sep 17 00:00:00 2001
From: Brecht Van Lommel <brecht@blender.org>
Date: Wed, 22 May 2024 21:32:05 +0200
Subject: [PATCH 3/4] Fix error building bitcode a second time

---
 premake5.lua | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/premake5.lua b/premake5.lua
index f76a8bd..76a3370 100644
--- a/premake5.lua
+++ b/premake5.lua
@@ -242,7 +242,7 @@ workspace "hiprt"
             os.execute("mkdir hiprt\\cache")
             os.execute("tools\\bakeKernel.bat")
         else
-            os.execute("mkdir hiprt/cache")
+            os.execute("mkdir -p hiprt/cache")
             os.execute("./tools/bakeKernel.sh")
         end
         if _OPTIONS["bakeKernel"] then
-- 
2.43.2


From c383f3888d5132f1b193b550dcef7d242b8aa879 Mon Sep 17 00:00:00 2001
From: Brecht Van Lommel <brecht@blender.org>
Date: Wed, 22 May 2024 21:32:22 +0200
Subject: [PATCH 4/4] Fix failure to bake due to missing "python" command on
 Linux

For example Ubuntu only has a python3 command, and this should be
available on all Linux distributions.
---
 tools/bakeKernel.sh | 84 ++++++++++++++++++++++-----------------------
 1 file changed, 42 insertions(+), 42 deletions(-)

diff --git a/tools/bakeKernel.sh b/tools/bakeKernel.sh
index 21cbfe2..cdc914b 100755
--- a/tools/bakeKernel.sh
+++ b/tools/bakeKernel.sh
@@ -5,66 +5,66 @@ echo "// automatically generated, don't edit" > hiprt/cache/KernelArgs.h
 echo "// automatically generated, don't edit" > contrib/Orochi/ParallelPrimitives/cache/Kernels.h
 echo "// automatically generated, don't edit" > contrib/Orochi/ParallelPrimitives/cache/KernelArgs.h
 
-python tools/stringify.py ./contrib/Orochi/ParallelPrimitives/RadixSortKernels.h  >> contrib/Orochi/ParallelPrimitives/cache/Kernels.h
-python tools/genArgs.py ./contrib/Orochi/ParallelPrimitives/RadixSortKernels.h  >> contrib/Orochi/ParallelPrimitives/cache/KernelArgs.h
-python tools/stringify.py ./contrib/Orochi/ParallelPrimitives/RadixSortConfigs.h  >> contrib/Orochi/ParallelPrimitives/cache/Kernels.h
+python3 tools/stringify.py ./contrib/Orochi/ParallelPrimitives/RadixSortKernels.h  >> contrib/Orochi/ParallelPrimitives/cache/Kernels.h
+python3 tools/genArgs.py ./contrib/Orochi/ParallelPrimitives/RadixSortKernels.h  >> contrib/Orochi/ParallelPrimitives/cache/KernelArgs.h
+python3 tools/stringify.py ./contrib/Orochi/ParallelPrimitives/RadixSortConfigs.h  >> contrib/Orochi/ParallelPrimitives/cache/Kernels.h
 
 echo "#pragma once" >> hiprt/cache/Kernels.h
 echo "#pragma once" >> hiprt/cache/KernelArgs.h
 
-python tools/stringify.py ./hiprt/impl/Math.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/hiprt_vec.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Aabb.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/AabbList.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/BvhCommon.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/BvhNode.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Geometry.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/QrDecomposition.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Quaternion.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Transform.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Instance.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/InstanceList.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/MortonCode.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Scene.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/TriangleMesh.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/Triangle.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/BvhBuilderUtil.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/SbvhCommon.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/ApiNodeList.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/BvhConfig.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/impl/MemoryArena.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/hiprt_types.h 20220318  >> hiprt/cache/Kernels.h
-python tools/stringify.py ./hiprt/hiprt_common.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Math.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/hiprt_vec.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Aabb.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/AabbList.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/BvhCommon.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/BvhNode.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Geometry.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/QrDecomposition.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Quaternion.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Transform.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Instance.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/InstanceList.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/MortonCode.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Scene.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/TriangleMesh.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/Triangle.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/BvhBuilderUtil.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/SbvhCommon.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/ApiNodeList.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/BvhConfig.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/impl/MemoryArena.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/hiprt_types.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/stringify.py ./hiprt/hiprt_common.h 20220318  >> hiprt/cache/Kernels.h
 
 
 # hiprt_device_impl.h
-python tools/stringify.py ./hiprt/impl/hiprt_device_impl.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/hiprt_device_impl.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/hiprt_device_impl.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/hiprt_device_impl.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # hiprt_device.h
-python tools/stringify.py ./hiprt/hiprt_device.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/hiprt_device.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/hiprt_device.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/hiprt_device.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # BvhBuilderKernels.h
-python tools/stringify.py ./hiprt/impl/BvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/BvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/BvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/BvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # LbvhBuilderKernels.h
-python tools/stringify.py ./hiprt/impl/LbvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/LbvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/LbvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/LbvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # PlocBuilderKernels.h
-python tools/stringify.py ./hiprt/impl/PlocBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/PlocBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/PlocBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/PlocBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # SbvhBuilderKernels.h
-python tools/stringify.py ./hiprt/impl/SbvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/SbvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/SbvhBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/SbvhBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # BatchBuilderKernels.h
-python tools/stringify.py ./hiprt/impl/BatchBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/BatchBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/BatchBuilderKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/BatchBuilderKernels.h 20220318  >> hiprt/cache/KernelArgs.h
 
 # BvhImporterKernels.h
-python tools/stringify.py ./hiprt/impl/BvhImporterKernels.h 20220318  >> hiprt/cache/Kernels.h
-python tools/genArgs.py ./hiprt/impl/BvhImporterKernels.h 20220318  >> hiprt/cache/KernelArgs.h
+python3 tools/stringify.py ./hiprt/impl/BvhImporterKernels.h 20220318  >> hiprt/cache/Kernels.h
+python3 tools/genArgs.py ./hiprt/impl/BvhImporterKernels.h 20220318  >> hiprt/cache/KernelArgs.h
-- 
2.43.2

