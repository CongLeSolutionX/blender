<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Coverage</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/default.min.css"
      integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/a11y-dark.min.css"
      integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"
      integrity="sha512-6yoqbrcLAHDWAdQmiRlHG4+m0g/CT/V9AGyxabG8j7Jk8j3r3K6due7oqpiRMZqcYe9WM2gPcaNNxnl2ux+3tA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.6.0/highlightjs-line-numbers.min.js"
      integrity="sha512-nkjLcPbHjdAof51b8uUd+6q4YH7YrMwh+kfTwSBrg5T/yMKrz8GUxM4uJJ1xAL7Q1lfAMIEowDsTzfWskZ5RcQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.2.0/highlightjs-highlight-lines.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }

      body {
        background: #2b2b2b;
      }

      #summary {
        color: #d4d0ab;
        border-bottom: #535353 1px solid;
        padding: 0.5em;
        font-size: large;
        font-family: monospace;
      }

      a {
        color: #d4d0ab;
      }

      a:hover {
        color: aqua;
      }

      /* For block of numbers. */
      .hljs-ln-numbers {
        user-select: none;
        text-align: right;
        color: #ccc;
        border-right: 1px solid #ccc;
        vertical-align: top;
        padding-right: 0.5em !important;
      }

      /* For block of code. */
      .hljs-ln-code {
        padding-left: 0.5em !important;
      }

      .line-call-count {
        color: #f7f2f2;
        font-size: 80%;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <div id="summary">
      <p>File: SOURCE_FILE_PATH</p>
      <p><a href="INDEX_PAGE_LINK">Back to Overview</a></p>
      <br />
      <p>Lines: <span id="coverage-lines"></span></p>
      <p>Functions: <span id="coverage-functions"></span></p>
    </div>
    <pre><code class="language-cpp" id="source-code"></code></pre>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/es/languages/cpp.min.js"
      integrity="sha512-W7ylVGHTqpHcaLw4Fk096Y7lV7Tz+/r7Ca+Og+oZiar+XxRf4Yd/LNgv4HpbRRpahPip1NihtK3CZ8r3eZ5Umw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        source_code = await str_from_gzip_base64(source_code_compressed_base64);
        analysis_data = JSON.parse(await str_from_gzip_base64(analysis_data_compressed_base64));

        document.getElementById("source-code").innerHTML = escapeHtml(source_code);

        prepare_analysis_data();

        hljs.highlightAll();
        hljs.initLineNumbersOnLoad();
        set_line_background_colors();

        // Need to delay here in case the line background colors are not set immediately.
        const interval = window.setInterval(() => {
          if (document.querySelector(".hljs-ln-code .hljs-ln-line")) {
            clearInterval(interval);
            create_overview();
            augment_lines();
          }
        }, 10);
      });

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function prepare_analysis_data() {
        for (const [function_key, fdata] of Object.entries(analysis_data.functions)) {
          num_functions++;
          if (fdata.execution_count > 0) {
            num_run_functions++;
          }
          for (const [line_index_str, count] of Object.entries(fdata.lines)) {
            const line_index = parseInt(line_index_str);
            count_by_line.set(line_index, count);
            num_executable_lines++;
            if (count > 0) {
              num_run_lines++;
            }
          }
        }
        for (const [line_index_str, count] of Object.entries(analysis_data.loose_lines)) {
          const line_index = parseInt(line_index_str);
          count_by_line.set(line_index, count);
          num_executable_lines++;
          if (count > 0) {
            num_run_lines++;
          }
        }
      }

      function set_line_background_colors() {
        const line_colors = [];
        for (let [line_index, hit_count] of count_by_line.entries()) {
          line_colors.push({
            start: line_index + 1,
            end: line_index + 1,
            color: hit_count_to_color(hit_count),
          });
        }

        hljs.highlightLinesAll([line_colors]);
      }

      function hit_count_to_color(hit_count) {
        if (hit_count == 0) {
          return "rgb(65 48 48)";
        }
        return "rgb(42 53 42)";
      }

      function augment_lines() {
        let line_index = 0;
        for (const line_element of document.querySelectorAll(".hljs-ln-code .hljs-ln-line")) {
          const hit_count = count_by_line.get(line_index++);
          if (!hit_count) {
            continue;
          }
          const call_count_element = document.createElement("span");
          call_count_element.className = "line-call-count";
          call_count_element.innerText = "  " + hit_count.toLocaleString() + "x";
          line_element.appendChild(call_count_element);
        }
      }

      function create_overview() {
        document.getElementById(
          "coverage-lines"
        ).innerText = `${num_run_lines} / ${num_executable_lines} (${ratio_to_percent(
          num_run_lines,
          num_executable_lines
        )}%)`;
        document.getElementById(
          "coverage-functions"
        ).innerText = `${num_run_functions} / ${num_functions} (${ratio_to_percent(
          num_run_functions,
          num_functions
        )}%)`;
      }

      function ratio_to_percent(numerator, denominator) {
        return fraction_to_percent(ratio_to_fraction(numerator, denominator));
      }

      function ratio_to_fraction(numerator, denominator) {
        if (denominator == 0) {
          return 1;
        }
        return numerator / denominator;
      }

      function fraction_to_percent(f) {
        if (f >= 1) {
          return 100;
        }
        if (f >= 0.99) {
          // Avoid showing 100% if there is still something missing.
          return 99;
        }
        if (f <= 0) {
          return 0;
        }
        if (f <= 0.01) {
          // Avoid showing 0% if there is some coverage already.
          return 1;
        }
        return Math.round(f * 100);
      }

      async function str_from_gzip_base64(data_compressed_base64) {
        const compressed = atob(data_compressed_base64);
        const compressed_bytes = new Uint8Array(compressed.length);
        for (let i = 0; i < compressed.length; i++) {
          compressed_bytes[i] = compressed.charCodeAt(i);
        }
        const compressed_blob = new Blob([compressed_bytes]);
        const stream = new Response(compressed_blob).body.pipeThrough(
          new DecompressionStream("gzip")
        );
        const result = await new Response(stream).text();
        return result;
      }

      const count_by_line = new Map();
      let num_executable_lines = 0;
      let num_run_lines = 0;
      let num_functions = 0;
      let num_run_functions = 0;

      const source_code_compressed_base64 = "SOURCE_CODE";
      const analysis_data_compressed_base64 = "ANALYSIS_DATA";
      // Will be decompressed a bit later.
      let source_code = undefined;
      let analysis_data = undefined;
    </script>
  </body>
</html>
